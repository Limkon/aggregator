name: Aggregator Daily Build

on:
  schedule:
    # 每5天 UTC 时间 0:00 运行 (北京时间 8:00)
    - cron: '0 0 */5 * *'
  workflow_dispatch:
    # 允许手动触发，并加入一个强制爬取的选项以备不时之需
    inputs:
      force_crawl:
        description: '强制重新爬取 (无视已存在的 raw-nodes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  actions: read # 必须授予此权限，工作流才能使用 gh CLI 读取历史运行记录和下载跨运行工件

jobs:
  # --- 第一阶段：下载与聚合 ---
  fetch_raw:
    runs-on: ubuntu-latest
    outputs:
      skip_crawl: ${{ steps.check_artifact.outputs.skip_crawl }}
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Check and Restore Existing raw-nodes
      id: check_artifact
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ "${{ github.event.inputs.force_crawl }}" == "true" ]; then
          echo "用户选择了强制重新爬取，跳过工件检查。"
          echo "skip_crawl=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "正在检查历史记录中尚未过期的 'raw-nodes'..."
        WORKFLOW_FILE=$(basename "${{ github.workflow_ref }}" | cut -d'@' -f1)
        
        # 排除当前正在运行的 ID，抓取上一次成功保存的 raw-nodes
        PREV_RUN_ID=$(gh run list --workflow "$WORKFLOW_FILE" --json databaseId --jq '[.[] | select(.databaseId != '${{ github.run_id }}')] | .[0].databaseId // empty' || echo "")
        
        if [ -n "$PREV_RUN_ID" ]; then
          echo "找到上一次历史运行 ID: $PREV_RUN_ID"
          if gh run download "$PREV_RUN_ID" -n raw-nodes --dir .; then
            echo "成功下载未过期的 raw-nodes，将跳过本轮节点爬取！"
            echo "skip_crawl=true" >> $GITHUB_OUTPUT
          else
            echo "上一次运行的 raw-nodes 已过期被清理或不存在，需要重新爬取。"
            echo "skip_crawl=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "未找到任何历史运行记录，需要重新爬取。"
          echo "skip_crawl=false" >> $GITHUB_OUTPUT
        fi

    - name: Set up Python
      if: steps.check_artifact.outputs.skip_crawl != 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      if: steps.check_artifact.outputs.skip_crawl != 'true'
      run: |
        pip install requests PyYAML

    - name: Run Aggregator Script
      if: steps.check_artifact.outputs.skip_crawl != 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python aggregator.py

    - name: Upload Raw Artifact
      uses: actions/upload-artifact@v4
      with:
        name: raw-nodes
        path: nodes.txt
        retention-days: 1
        overwrite: true

  # --- 第二阶段：测试与清洗 ---
  check_active:
    needs: fetch_raw
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Download Raw Artifact
      uses: actions/download-artifact@v4
      with:
        name: raw-nodes

    # --- [核心修改] 加入本地回退逻辑 ---
    - name: Install Environment & Prepare GeoIP Database
      run: |
        pip install maxminddb
        
        echo "尝试下载最新的 GeoLite2-Country 数据库..."
        # 设置了 15 秒超时 (-T 15)，防止网络卡死
        if wget -T 15 -qO geoip.mmdb "https://github.com/P3TERX/GeoLite.mmdb/releases/latest/download/GeoLite2-Country.mmdb"; then
          echo "✅ 成功下载并部署最新的 GeoIP 数据库。"
        else
          echo "⚠️ 下载最新 GeoIP 数据库失败，开始启用本地回退策略！"
          if [ -f "GeoLite2-Country.mmdb" ]; then
            cp GeoLite2-Country.mmdb geoip.mmdb
            echo "✅ 成功拷贝本地 GeoLite2-Country.mmdb 用于节点测速重命名。"
          else
            echo "❌ 错误：本地也未找到 GeoLite2-Country.mmdb，测速程序可能无法提供地理位置。"
          fi
        fi

    - name: Run Check Active Script
      run: |
        python check_active.py

    - name: Publish to Release Branch
      run: |
        mkdir -p publish_dir
        cp sub.txt publish_dir/
        cp nodes.txt publish_dir/
        cd publish_dir
        
        git init
        git checkout -b release
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add .
        git commit -m "Auto-update valid nodes [$(date)]" || exit 0
        
        git push --force "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" release
