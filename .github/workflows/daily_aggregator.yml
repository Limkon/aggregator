name: Aggregator Daily Build

on:
  schedule:
    # 每5天 UTC 时间 0:00 运行 (北京时间 8:00)
    - cron: '0 0 */5 * *'
  workflow_dispatch:
    inputs:
      force_crawl:
        description: '强制重新爬取 (无视已存在的 raw-nodes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  actions: read # 必须授予此权限，工作流才能使用 gh CLI 读取历史运行记录

jobs:
  # --- 第一阶段：下载与聚合 ---
  fetch_raw:
    runs-on: ubuntu-latest
    outputs:
      skip_crawl: ${{ steps.check_artifact.outputs.skip_crawl }}
    steps:
    - name: Checkout Code
      uses: actions/checkout@main

    - name: Check and Restore Existing raw-nodes
      id: check_artifact
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ "${{ github.event.inputs.force_crawl }}" == "true" ]; then
          echo "用户选择了强制重新爬取，跳过工件检查。"
          echo "skip_crawl=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "正在检查历史记录中尚未过期的 'raw-nodes'..."
        WORKFLOW_FILE=$(basename "${{ github.workflow_ref }}" | cut -d'@' -f1)
        PREV_RUN_ID=$(gh run list --workflow "$WORKFLOW_FILE" --json databaseId --jq '[.[] | select(.databaseId != '${{ github.run_id }}')] | .[0].databaseId // empty' || echo "")
        
        if [ -n "$PREV_RUN_ID" ]; then
          echo "找到上一次历史运行 ID: $PREV_RUN_ID"
          if gh run download "$PREV_RUN_ID" -n raw-nodes --dir .; then
            echo "成功下载未过期的 raw-nodes，将跳过本轮节点爬取！"
            echo "skip_crawl=true" >> $GITHUB_OUTPUT
          else
            echo "上一次运行的 raw-nodes 已过期被清理或不存在，需要重新爬取。"
            echo "skip_crawl=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "未找到任何历史运行记录，需要重新爬取。"
          echo "skip_crawl=false" >> $GITHUB_OUTPUT
        fi

    - name: Set up Python
      if: steps.check_artifact.outputs.skip_crawl != 'true'
      uses: actions/setup-python@main
      with:
        python-version: 'x'

    - name: Install Dependencies
      if: steps.check_artifact.outputs.skip_crawl != 'true'
      run: |
        pip install requests PyYAML

    - name: Run Aggregator Script
      if: steps.check_artifact.outputs.skip_crawl != 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python aggregator.py

    - name: Upload Raw Artifact
      uses: actions/upload-artifact@v4
      with:
        name: raw-nodes
        path: nodes.txt
        retention-days: 1
        overwrite: true

  # --- 第二阶段：测试与清洗 ---
  check_active:
    needs: fetch_raw
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@main
      with:
        # [关键设置] 需要获取完整的 Git 历史以便后续可以 push 回主分支
        fetch-depth: 0 

    - name: Set up Python
      uses: actions/setup-python@main
      with:
        python-version: 'x'

    - name: Download Raw Artifact
      uses: actions/download-artifact@main
      with:
        name: raw-nodes

    # --- [核心进化] 下载、检测、自更新代码库 ---
    - name: Install Environment & Update GeoIP Database
      run: |
        pip install maxminddb
        
        echo "尝试下载最新的 GeoLite2-Country 数据库..."
        # 先下载到一个临时文件，防止下载残缺直接覆盖了本地的好文件
        if wget -T 15 -qO temp_GeoLite2.mmdb "https://github.com/P3TERX/GeoLite.mmdb/releases/latest/download/GeoLite2-Country.mmdb"; then
          echo "✅ 成功下载最新的 GeoIP 数据库。"
          
          # 替换掉本地的文件
          mv temp_GeoLite2.mmdb GeoLite2-Country.mmdb
          cp GeoLite2-Country.mmdb geoip.mmdb
          
          # 检查文件是否和当前分支中的版本有区别 (或者第一次添加)
          if [ -n "$(git status --porcelain GeoLite2-Country.mmdb)" ]; then
            echo "发现 GeoIP 数据库存在更新，正在将其同步推送回当前代码分支..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            
            git add GeoLite2-Country.mmdb
            # 加上 [skip ci] 防止这次提交再次触发工作流导致死循环
            git commit -m "Auto-update GeoLite2-Country.mmdb [skip ci]"
            # 自动推送到触发工作流的当前分支
            git push origin HEAD:${{ github.ref_name }}
            echo "✅ 数据库代码库同步完成！"
          else
            echo "✅ 当前分支的数据库已是最新，无需执行 Git 提交。"
          fi
          
        else
          echo "⚠️ 下载最新 GeoIP 数据库失败或超时，开始启用本地回退策略！"
          rm -f temp_GeoLite2.mmdb # 清理可能下载残缺的临时文件
          
          if [ -f "GeoLite2-Country.mmdb" ]; then
            cp GeoLite2-Country.mmdb geoip.mmdb
            echo "✅ 成功提取当前分支中历史缓存的 GeoLite2-Country.mmdb 用于节点解析。"
          else
            echo "❌ 错误：本地也未找到 GeoLite2-Country.mmdb。"
          fi
        fi

    - name: Run Check Active Script
      run: |
        python check_active.py

    - name: Publish to Release Branch
      run: |
        mkdir -p publish_dir
        cp sub.txt publish_dir/
        cp nodes.txt publish_dir/
        cd publish_dir
        
        git init
        git checkout -b release
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add .
        git commit -m "Auto-update valid nodes [$(date)]" || exit 0
        
        git push --force "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" release
